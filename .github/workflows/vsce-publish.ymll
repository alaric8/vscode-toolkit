name: VSIX publish
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
permissions:
  contents: write
jobs:
  build-vsix:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ 设置 Node.js 环境
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22" # 可根据项目需要选择 Node 版本
          cache: "npm"

      # 3️⃣ 安装依赖
      - name: Install dependencies
        run: npm ci

      # 4️⃣ 安装 vsce 打包工具
      - name: Install VSCE
        run: npm install -g @vscode/vsce

      # 5️⃣ 编译 TypeScript（vscode:prepublish）
      - name: Prepublish (compile & bundle)
        run: npm run vscode:prepublish

      # 6️⃣ 打包生成 VSIX 文件
      - name: Package VSIX
        run: vsce package

      # 7️⃣ 上传 VSIX 作为 artifact（v4）
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: rest-client-vsix
          path: "*.vsix"
          retention-days: 30 # 可选，保存 artifact 30 天
          if-no-files-found: error # 如果没有找到 VSIX 文件则报错name: VSIX publish
