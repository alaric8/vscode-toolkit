name: VSIX publish
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
permissions:
  contents: write
jobs:
  build-vsix:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ 安装 pnpm（确保 runner 能找到命令）
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9 # 或指定你项目里的版本，比如 8

      # 3️⃣ 设置 Node.js 环境，并启用 pnpm 缓存
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "22"
          cache: "pnpm"

      # 4️⃣ 安装依赖
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5️⃣ 安装 vsce 打包工具
      - name: Install VSCE
        run: pnpm add -g @vscode/vsce

      # 6️⃣ 编译 TypeScript（vscode:prepublish）
      - name: Prepublish (compile & bundle)
        run: pnpm run vscode:prepublish

      # 7️⃣ 打包生成 VSIX 文件
      - name: Package VSIX
        run: vsce package

      # 8️⃣ 上传 VSIX 作为 artifact（v4）
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: rest-client-vsix
          path: "*.vsix"
          retention-days: 30
          if-no-files-found: error
